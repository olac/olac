<?php
#
# Synopsis: Display the archive informaion from the olac database.
#
# ChangeLog:
#
# 2008-03-03  use repository identifier to search the db
#             obtain repository id from path info -HL
# 
# 2005-01-19  Steven Bird  <sb@ldc.upenn.edu>
#	* change URL of repository explorer
#
# 2004-11-10  Haejoong Lee  <haejoong@ldc.upenn.edu>
#	* set character encoding to utf-8
#
# 2004-01-28  Steven Bird  <sb@ldc.upenn.edu>
#       * linked to archive report cards
#
# 2003-03-05  Haejoong Lee  <haejoong@ldc.upenn.edu>
#	* don't display empty entries
#	* shortLocation should appear
#
# 2003-02-28  Haejoong Lee  <haejoong@ldc.upenn.edu>
#	* created based on previous version built on olac 0.4 db
#

require_once("lib/php/OLACDB.php");
$DB = new OLACDB("olac2");

############################################################
# returns a hash of the following form
#
#   display string ==> value
############################################################
function get_archive_info($id)
{
    global $DB;

    $tab = $DB->sql("select *
		     from   OLAC_ARCHIVE
		     where  RepositoryIdentifier='$id'");
    if (! $tab) {
      print "Invalid archive id: $id";
      echo "\n</body>\n</html>";
      exit;
    }
    $archiveid = $tab[0]['Archive_ID'];
    $tab1 = $DB->sql("select count(Item_ID) as size
		      from   ARCHIVED_ITEM
		      where  Archive_ID=$archiveid");
    $tab2 = $DB->sql("select distinct SchemaName
		      from   ARCHIVED_ITEM as A, SCHEMA_VERSION as S
		      where  A.Archive_ID=$archiveid and A.Schema_ID=S.Schema_ID");
    $r = $tab[0];

    $o[Size] = $tab1[0][size];
    $o[RepositoryName] = $r[RepositoryName];
    $i = $r[Institution];
    $iu = $r[InstitutionURL];
    if ($i) {
      if ($iu) $o[Institution] = "<a href=\"$iu\">$i</a>";
      else     $o[Institution] = $i;
    } else if ($iu)
	       $o[Institution] = "<a href=\"$iu\">$iu</a>";
    else       $o[Institution] = "";
    $o[ArchiveURL] = "<a href=\"$r[ArchiveURL]\">$r[ArchiveURL]</a>";
    $c = $r[Curator];
    $ce = str_replace('mailto:', '', $r[CuratorEmail]);
    if ($c) {
      if ($ce) $o[Curator] = "<a href=\"mailto:$ce\">$c</a>";
      else     $o[Curator] = $c;
    } else if ($ce)
	       $o[Curator] = "<a href=\"mailto:$ce\">$ce</a>";
    else       $o[Curator] = "";
    $o[Location] = $r[Location];
    $o['Short location'] = $r[ShortLocation];
    $o[Synopsis] = $r[Synopsis];
    $o[Access] = $r[Access];
    $r[AdminEmail] = str_replace('mailto:', '', $r[AdminEmail]);
    $o[Administrator] = "<a href=\"mailto:$r[AdminEmail]\">$r[AdminEmail]</a>";
    $o["Base URL"] = $r[BaseURL];
    $o["Repository ID"] = $r[RepositoryIdentifier];
    $o["OAI version"] = $r[OaiVersion];
    foreach ($tab2 as $v) {
	$o["OLAC MS version(s)"] .= "$v[SchemaName] ";
    }
    $o["Records in archive"] = "<a href=\"/archive_records/$id\">http://www.language-archives.org/archive_records/$id</a>";
    $o[Explore] = "<a href=\"http://re.cs.uct.ac.za/cgi-bin/Explorer/2.0-1.46/testoai?archive=$r[BaseURL]\">Visit archive with the Repository Explorer</a>";
    $o["Last harvested"] = $r[LastHarvested];

    # added by SB on 2004-01-23:
    $o["Reports"] = "<a href=\"/metrics/$id\">Archive Metrics</a> and <a href=\"/checks/$id\">Integrity Checks</a>";

    return $o;
}

?>



<html>
<head>
<title>OLAC - Archive details</title>
<link rel="stylesheet" type="text/css" href="/olac.css">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body bgcolor=white>

<?php

$archiveid = $_GET[id];
if (!$archiveid) {
	$arr = explode('?', $_SERVER["REQUEST_URI"]);
	$archiveid = basename($arr[0]);
}
$record = get_archive_info($archiveid);
?>
<hr>
<table cellpadding=10>
<tr><td><a href="/"><img src="/images/olac100.gif" border=0></a></td>
<td><h1>Archive Details</h1></td></tr>
</table>
<hr>
<?php
echo "<h2>$record[RepositoryName]</h2>";
echo "<table>";
foreach ($record as $k => $v) {
    if (! preg_match('/^\s*$/', $v)) {
        echo "<tr><td align=right valign=top>$k:</td>";
        echo "<td><font color=blue>$v</font></td></tr>\n";
    }
}
echo "</table>";
?>

</body>
</html>
