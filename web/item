<?php
######################################################################
# synopsis:
#   Metadata lookup program for OLAC 1.0 MySQL database
#
# usage:
#   http://www.language-archives.org/tools/lookup  or
#   http://www.language-archives.org/tools/lookup/index.php?identifier=<oai-id>
#
#   <oai-id>  OAI record identifier
#
# changes:
#   2008-05-16  modify GA script to include tracker for ArchiveURL -SB
#   2008-03-03  obtain item identifier from the path info as well -HL
#   2008-02-06  added GA script; added search terms -HL
#   2008-01-28  fixed an sql query because it didn't pick up all
#               metadata elements -HL
#   2004-11-10  set character encoding to UTF-8 - HL
#   2003-02-28  use olac2 - HL
#   2003-02-26  revised for OLAC 1.0 with "display" format - HL
#   2002-??-??  Haejoong Lee revised it
#   2002-??-??  Steven Bird wrote it originally
######################################################################

define(OLAC_DB_NAME, 'olac2');
require_once("/web/language-archives/lib/php/OLACDB.php");
$DB = new OLACDB(OLAC_DB_NAME);
$DB->sql("set names 'utf8'");


function draw_form() {
  print <<<END
<html>
<head>
<title>OLAC Metadata Lookup</title>
<link rel="stylesheet" type="text/css" href="/olac.css">
</head>
<body>

<form action="$_SERVER[PHP_SELF]" method="get">
OAI identifier:
<input type="text" name="identifier" size="40"/>
<input type="submit" value="Lookup!"/>
</form>

</body>
</html>
END;
    exit;
}

function error_page($msg) {
    print <<<END
<html>
<head>
<title>OLAC Metadata Lookup</title>
<link rel="stylesheet" type="text/css" href="/olac.css">
</head>
<body>
<p><b><font color=red>$msg</font></b>
</body>
</html>
END;
    exit;
}

function tokenizeQuery($queryString)
{
    $tokens = array();
    $separators = " \t";

    $booleanKeywords = Array ( "and", "or", "not" );

    if ( (array_key_exists('mode', $_GET)) && ($_GET['mode'] == 'phrase') )
    {
        $tokens[0]= trim($queryString);
        return $tokens;
    }

    $tok = strtok($queryString, $separators);
    $i=0;
    while ($tok)
    {
        if ( in_array( $tok, $booleanKeywords )  )
        {
                # FIXME
                $i--;
        }
        else
        {
        $tokens[$i] = $tok;
        }
        $tok = strtok( $separators );
        $i++;

    }

    return $tokens;

}


$itemid=$_GET['identifier'];
if (!$itemid) {
	$arr = explode('?', $_SERVER["REQUEST_URI"]);
	$arr = explode('/oai:', $arr[0]);
	$itemid = "oai:" . $arr[1];
}
$itemid or draw_form();

$tab = $DB->sql("
    select OA.RepositoryName, OA.BaseURL,       OA.Archive_ID,
           AI.Item_ID,        AI.OaiIdentifier, AI.DateStamp,
	   OA.RepositoryIdentifier
    from   OLAC_ARCHIVE OA, ARCHIVED_ITEM AI
    where  AI.OaiIdentifier = '$itemid'
    and    OA.Archive_ID = AI.Archive_ID");
if ($DB->saw_error()) {
    header("HTTP/1.0 500 Internal Server Error");
    error_page("Query failed");
}
if (!$tab) {
    header("HTTP/1.0 404 Not Found");
    error_page("Record not found");
}
$body = "<h2>OLAC Record: $itemid</h2>\n";

$answer = $tab[0];

$olac_info = <<<END
<tr>
  <td colspan=3><br><p><b>OLAC Info</b></td>
</tr>
<tr>
  <td class=lookup><i>Archive:&nbsp;</i></td>
  <td></td>
  <td>$answer[RepositoryName]</td>
</tr>
<tr>
  <td class=lookup><i>Description:&nbsp;</i></td>
  <td></td>
  <td><a href="http://www.language-archives.org/archive/$answer[RepositoryIdentifier]">http://www.language-archives.org/archive/$answer[RepositoryIdentifier]</a></td>
</tr>
<tr>
  <td class=lookup><i>GetRecord:&nbsp;</i></td>
  <td></td>
  <td><a href="$answer[BaseURL]?verb=GetRecord&identifier=$itemid&metadataPrefix=olac">OAI-PMH request for OLAC format</a></td>
END;

$oai_info = <<<END
<tr>
  <td colspan=3><br><p><b>OAI Info</b></td>
</tr>
<tr>
  <td class=lookup><i>OaiIdentifier:&nbsp;</i></td>
  <td></td>
  <td><a href="/item/$answer[OaiIdentifier]">$answer[OaiIdentifier]</a></td>
</tr>
<tr>
  <td class=lookup><i>DateStamp:&nbsp;</i></td>
  <td></td><td>$answer[DateStamp]</td>
</tr>
<tr>
  <td class=lookup><i>GetRecord:&nbsp;</i></td>
  <td></td>
  <td><a href="http://www.language-archives.org/cgi-bin/olaca3.pl?verb=GetRecord&identifier=$itemid&metadataPrefix=oai_dc">OAI-PMH request for simple DC format</a></td>
</tr>
END;

$analytics = <<<END
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript"></script>
<script type="text/javascript">
_uacct = "UA-427085-3";
urchinTracker('item/');
urchinTracker('archive_item_hits/$answer[RepositoryIdentifier]');
</script>
END;

$analytics_link = "onClick=\"javascript:urchinTracker('archive_item_clicks/$answer[RepositoryIdentifier]')\"";

#$tab = $DB->sql("
#   select ed.Label as TagLabel, ed2.Label as DcTag,
#           Lang, Content, ex.Label as Type, cd.Label as Code
#    from   ELEMENT_DEFN ed, ELEMENT_DEFN ed2,
#           METADATA_ELEM me, EXTENSION ex, CODE_DEFN cd 
#    where  Item_ID=$answer[Item_ID]
#    and    ed2.Tag_ID = ed.DcElement
#    and    me.Extension_ID=ex.Extension_ID
#    and    me.Extension_ID=cd.Extension_ID
#    and    (cd.Code='' or me.Code=cd.Code)
#    and    me.Tag_ID = ed.Tag_ID
#    order by ed.Rank");
$tab = $DB->sql("
	select ed.Label as TagLabel, ed2.Label as DcTag, Lang, Content, me.Type Type, me.Code Code, lc.LangID, lc.Name LangName
	from METADATA_ELEM me
	left join ELEMENT_DEFN ed on me.Tag_ID=ed.Tag_ID
	left join ELEMENT_DEFN ed2 on ed2.Tag_ID=ed.DcElement
	#left join CODE_DEFN cd on cd.Extension_ID=me.Extension_ID and cd.Code=me.Code
        left join LanguageCodes lc on me.Code=lc.LangID
	where Item_ID=$answer[Item_ID]
	order by ed.Rank
");
$DB->saw_error() and error_page("Query failed");

$prev_field = "";
$meta = "";
$meta_description = "";
$meta_keywords = "";
$body .= "<p><table cellspacing=0 cellpadding=2 border=0>\n";
$body .= "<tr><td colspan=3><b>Metadata</b></td></tr>\n";
$search_terms = array();
$queryTokens = tokenizeQuery( $_GET['queryTerms'] );

foreach ($tab as $answer) {
    $tag = $meta_name = $answer[DcTag];
    $padding = '';
    $value = '';
    if ($answer[Type]) {
	if ($answer[Code]) {
	    $value = "[$answer[Type] = $answer[Code]]";
        } else {
            $value = "[$answer[Type]]";
        }
	$padding = ' ';
    }
    if ($answer[Content]) {
        $value .= $padding . $answer[Content];
        $padding = ' ';
    } else {
	if ($answer['Type'] == 'language' && $answer['Code']) {
		$value .= $padding . $answer['LangName'];
	}
    }
    if ($answer[TagLabel] != $answer[DcTag]) {
        $value .= $padding . "[$answer[TagLabel]]";
    }
	
    $meta_content = $value;
    $value = ereg_replace("(http:[^ ]+)", "<a href=\"\\1\" $analytics_link>\\1</a>", $value);
    $value = ereg_replace("(oai:[^: ]+:[^: ]+)", "<a href=\"/item/\\1\">\\1</a>", $value);
    $body .= "<tr><td class=lookup><i>";
    if ($tag != $prev_field) {
        $body .= "$tag:";
    }

    # search term highlighting
    foreach( $queryTokens as $tok ) {
        $tok = str_replace("(","\(",$tok);
        # Case insensitive matching of query keywords
        $value = eregi_replace($tok, '<em style="background:yellow">\\0</em>', $value );
    }

    $body .= "&nbsp;</i></td><td></td><td>$value</td></tr>\n";

    $meta_name = "DC." . ereg_replace(" .*", "", $meta_name);
    if ($meta_name == "DC.Description") $meta_name="Description";
    $meta .= "<meta name=\"$meta_name\" content=\"$meta_content\">\n";

    switch ($tag) {
	case "Title":
	    $title = $meta_content;
	    break;
	case "Description":
	    $meta_description .= "$meta_content ";
	    break;
	case "Subject":
	case "Subject language":
	case "Coverage":
	case "Type.linguistic":
	    $meta_keywords .= "$meta_content;";
	    break;
    }

    $prev_field = $tag;

    if ($answer['Type'] == 'language' && $answer['LangID']) {
	array_push($search_terms, "iso639_" . $answer['LangID']);
    } else if (($answer['Type'] == 'linguistic-type' ||
		$answer['Type'] == 'linguistic-field' ||
		$answer['Type'] == 'discourse-type') &&
		$answer['Code']) {
	array_push($search_terms, "olac_" . $answer['Code']);
    } else if ($answer['Type'] == 'DCMIType' && $answer['Content']) {
	array_push($search_terms, "dcmi_" . $answer['Content']);
    }
}


if ($search_terms) {
        sort($search_terms);
	$search_terms = array_unique($search_terms);
	$s = implode(" ", $search_terms);
	$search_info = <<<END
<tr>
  <td colspan=3><br><p><b>Search Info</b></td>
</tr>
<tr>
  <td class=lookup><i>Terms&nbsp;</i></td>
  <td></td>
  <td>$s</td>
</tr>
END;
} else {
	$search_info = "";
}


$body .= $olac_info;
$body .= $oai_info;
$body .= $search_info;
$body .= "</table>\n";

if ($meta_description && $meta_keywords) {
    $meta_description = substr($meta_description, 0, -1);
    $meta_keywords = substr($meta_keywords, 0, -1);
    $meta .= "<meta name=\"Description\" content=\"$meta_description\">\n";
    $meta .= "<meta name=\"Keywords\" content=\"$meta_keywords\">\n";
}

?>
<HTML>
<HEAD>
<TITLE><?=$title?></TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="/olac.css">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<?=$meta?>
</HEAD>

<BODY>

<?php
echo $body;
echo $analytics;
?>

</BODY>
</HTML>
